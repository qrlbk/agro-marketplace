# Матрица доступа (роли и страницы)

Разграничение по ролям платформы: кто какие зоны и страницы видит.

## Роли платформы

- **guest** — вошёл по OTP/demo, ещё не прошёл онбординг (выбор роли).
- **user** — обычный пользователь (покупатель).
- **farmer** — фермер (компания, гараж).
- **vendor** — поставщик (доступ к кабинету продавца при одобренной компании).
- **admin** — администратор платформы (админ-панель).

## Таблица доступа

| Зона / страница                         | guest                | user | farmer | vendor (одобрен)   | admin |
| --------------------------------------- | -------------------- | ---- | ------ | ------------------ | ----- |
| Каталог, товар, корзина                 | ✓                    | ✓    | ✓      | ✓                  | ✓     |
| Вход, онбординг                         | ✓ / только онбординг | —    | —      | —                  | —     |
| Гараж, заказы                           | —                    | ✓    | ✓      | ✓                  | ✓     |
| Кабинет продавца (прайс, товары, склад) | —                    | —    | —      | ✓ (если одобрен)   | ✓     |
| Уведомления                             | —                    | ✓    | ✓      | ✓                  | ✓     |
| Обратная связь                          | ✓ (форма)            | ✓    | ✓      | ✓                  | ✓     |
| Админ-панель `/admin/*`                 | —                    | —    | —      | —                  | ✓     |
| Сотрудники и журнал (внутри компании)   | —                    | —    | —      | по роли в компании | —     |

## Реализация

### Frontend (App.tsx)

- `/`, `/catalog`, `/products/:id` — без RequireAuth (каталог доступен всем).
- `/onboarding` — RequireAuth (гость после входа попадает сюда).
- `/garage`, `/cart`, `/orders` — RequireAuth + RequireOnboardingDone для garage/orders.
- `/admin/*` — RequireAuth + RequireRole roles={["admin"]}.
- `/vendor`, `/vendor/products`, `/vendor/warehouse`, `/vendor/team`, `/vendor/audit` — RequireAuth + RequireRole roles={["admin","vendor"]}. Одобрение компании проверяется на бэкенде (403 при неодобренной компании).
- `/notifications` — RequireAuth (все авторизованные).
- `/feedback` — без RequireAuth (форма доступна всем).

### Backend (dependencies.py, routers)

- `get_current_user` — обязательная авторизация.
- `require_role(*roles)` — проверка роли платформы.
- `get_current_vendor` — role in (vendor, admin) и для vendor — статус компании APPROVED.
- `get_current_admin` — только role=admin.
- Эндпоинты кабинета продавца используют `get_current_vendor`; для управления сотрудниками дополнительно проверяется роль в компании (owner).

### Доступ внутри компании продавца

Товары и заказы считаются «компанейскими»: доступ имеют все пользователи с тем же `company_id`. Управление сотрудниками и назначение ролей — только **owner** (и admin).

| Роль в компании | Прайс, товары, склад, заказы, журнал | Управление сотрудниками (пригласить, роль, удалить) |
| ----------------- | -------------------------------------- | ---------------------------------------------------- |
| owner             | ✓                                      | ✓                                                    |
| manager / warehouse / sales | ✓                              | —                                                    |

- **Товары:** редактировать/удалять может любой сотрудник компании (товар считается общим, если `product.vendor` в той же компании). Список «Мои товары» для vendor с `company_id` возвращает товары всех пользователей компании.
- **Заказы:** список заказов для vendor с `company_id` — все заказы, где `order.vendor_id` входит в компанию. Сменить статус заказа может админ или продавец этой компании.
- **Аудит:** в каждой записи хранятся `user_id`, `company_id`, `action`, `entity_type`, `entity_id`, `details`, `ip`, `created_at`.
